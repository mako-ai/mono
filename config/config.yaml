# Data Source Configuration
# Each data source represents a connection to external services or databases

data_sources:
  # Close.com Sources
  ch_close:
    name: "Switzerland Close CRM"
    description: "Close.com data for Swiss market operations"
    active: true
    type: "close"
    connection:
      api_key: "${CLOSE_API_KEY_SWITZERLAND}"
      api_base_url: "https://api.close.com/api/v1"
    settings:
      sync_batch_size: 100
      rate_limit_delay_ms: 200

  it_close:
    name: "Italy Close CRM"
    description: "Close.com data for Italian market operations"
    active: true
    type: "close"
    connection:
      api_key: "${CLOSE_API_KEY_ITALY}"
      api_base_url: "https://api.close.com/api/v1"
    settings:
      sync_batch_size: 100
      rate_limit_delay_ms: 200

  fr_close:
    name: "France Close CRM"
    description: "Close.com data for French market operations"
    active: true
    type: "close"
    connection:
      api_key: "${CLOSE_API_KEY_FRANCE}"
      api_base_url: "https://api.close.com/api/v1"
    settings:
      sync_batch_size: 100
      rate_limit_delay_ms: 200

  es_close:
    name: "Spain Close CRM"
    description: "Close.com data for Spanish market operations"
    active: true
    type: "close"
    connection:
      api_key: "${CLOSE_API_KEY_SPAIN}"
      api_base_url: "https://api.close.com/api/v1"
    settings:
      sync_batch_size: 100
      rate_limit_delay_ms: 250

  # Stripe Sources
  es_stripe:
    name: "Spain Stripe Payments"
    description: "Stripe payment data for Spanish operations"
    active: true
    type: "stripe"
    connection:
      api_key: "${STRIPE_API_KEY_SPAIN}"
    settings:
      sync_batch_size: 50
      rate_limit_delay_ms: 300

  # GraphQL Sources
  realadvisor_graphql:
    name: "RealAdvisor GraphQL API"
    description: "RealAdvisor GraphQL data source with custom queries"
    active: true # Set to true to enable
    type: "graphql"
    connection:
      endpoint: "https://hasura.realadvisor.com/v1/graphql"
      headers:
        "X-API-Version": "v1"
        "X-Client-Name": "RevOps-Sync"
        "x-hasura-admin-secret": "${REALADVISOR_HASURA_SECRET}"
      queries:
        - name: "teams"
          query: |
            query GetTeams($limit: Int!, $offset: Int!) {
              teams_aggregate {
                aggregate {
                  count
                }
              }
              teams(limit: $limit, offset: $offset, order_by: { id: desc_nulls_last}) {
                id
                created_at
                name
                show_in_agency_pages
                logo {
                  url
                }
                property_transactions_aggregate(where: { is_published: {_eq: true }}) {
                  aggregate {
                    count
                    max {
                      created_at
                    }
                  }
                }
                teams_users {
                  user {
                    id
                    first_name
                    last_name
                    user_images_aggregate {
                      aggregate {
                        count
                      }
                    }
                    reviews_aggregate(where: { completed: { _eq: true }}) {
                      aggregate {
                        count
                        max {
                          created_at
                        }
                        avg {
                          rating
                        }
                      }
                    }
                    activities_aggregate {
                      aggregate {
                        count
                        max {
                          created_at
                        }
                      }
                    }
                    appraisal_requests: lead_agents_aggregate(where: { source: { _eq: result_page } }) {
                      aggregate {
                        count
                        max {
                          created_at
                        }
                      }
                    }
                    assigned_leads: lead_agents_aggregate(where: { source: { _eq: automation }}) {
                      aggregate {
                        count
                        max {
                          created_at
                        }
                      }
                    }
                    emails {
                      email
                    }
                    phone_numbers {
                      number
                    }
                  }
                }
                tenant {
                  id
                  country_code
                }
              }
            }
          dataPath: "data.teams" # Direct access to teams array (no edges)
          totalCountPath: "data.teams_aggregate.aggregate.count" # For progress tracking

        - name: "users"
          query: |
            query GetUsers($limit: Int!, $offset: Int!) {
              users(limit: $limit, offset: $offset, order_by: { id: desc_nulls_last }) {
                id
                first_name
                last_name
                email
                created_at
                updated_at
                teams_users {
                  team {
                    id
                    name
                  }
                }
                tenant {
                  id
                  country
                  country_code
                  name
                }
              }
              users_aggregate {
                aggregate {
                  count
                }
              }
            }
          dataPath: "data.users"
          totalCountPath: "data.users_aggregate.aggregate.count"

        - name: "tenants"
          query: |
            query GetTenants($limit: Int!, $offset: Int!) {
              tenants(limit: $limit, offset: $offset, order_by: { id: desc_nulls_last }) {
                id
                name
                country
                country_code
                created_at
                updated_at
              }
              tenants_aggregate {
                aggregate {
                  count
                }
              }
            }
          dataPath: "data.tenants"
          totalCountPath: "data.tenants_aggregate.aggregate.count"
    settings:
      sync_batch_size: 100
      rate_limit_delay_ms: 500
      timeout_ms: 30000 # 30 seconds timeout for GraphQL requests

  # local_dev:
  #   name: "Local Development Server"
  #   description: "Local MongoDB instance for development"
  #   connection_string: "mongodb://localhost:27018"
  #   active: true
  #   databases:
  #     analytics_db:
  #       name: "Main Analytics Database"
  #       description: "Primary MongoDB for analytics data"
  #       database: "multi_tenant_analytics"
  #       active: true
  #       settings:
  #         max_pool_size: 10
  #         min_pool_size: 2

  #     datawarehouse:
  #       name: "Data Warehouse Database"
  #       description: "Primary MongoDB for data warehouse data"
  #       database: "datawarehouse"
  #       active: true
  #       settings:
  #         max_pool_size: 10
  #         min_pool_size: 2

  # Example of a production server (commented out)
  # production:
  #   name: "Production Cluster"
  #   description: "Production MongoDB Atlas cluster"
  #   connection_string: "mongodb+srv://user:pass@cluster.mongodb.net"
  #   active: true
  #   databases:
  #     analytics_prod:
  #       name: "Production Analytics"
  #       description: "Production analytics database"
  #       database: "analytics"
  #       active: true
  #       settings:
  #         max_pool_size: 20
  #         min_pool_size: 5

# Global settings that apply to all data sources (can be overridden per source)
global:
  max_retries: 5
  default_timezone: "UTC"
  logging:
    level: "info"
    include_api_responses: false
